# SPDX-License-Identifier: MIT-0
---
- name: Test qcontroller_vm Ansible role
  hosts: localhost
  connection: local
  vars:
    ansible_python_interpreter: "{{ ansible_playbook_python }}"
  remote_user: root
  tasks:
    - name: Download a sample VM image
      ansible.builtin.get_url:
        url: "https://cloud-images.ubuntu.com/noble/20251113/noble-server-cloudimg-amd64.img"
        checksum: "sha256:https://cloud-images.ubuntu.com/noble/20251113/SHA256SUMS"
        dest: "/tmp/focal-server-cloudimg-amd64.img"
        mode: "0644"
    - name: Test qcontroller_vm module - Start VM
      ansible.builtin.include_role:
        name: qcontroller
      vars:
        qcontroller_name: "my-vm"
        qcontroller_state: "running"
        qcontroller_image: "cloud-images:ubuntu-noble-20251113"
        qcontroller_file: "/tmp/focal-server-cloudimg-amd64.img"
        qcontroller_timeout: 600
        qcontroller_userdata: |
          #cloud-config
          ssh_pwauth: true
          users:
            - name: exampleuser
              sudo: ALL=(ALL) NOPASSWD:ALL
              shell: /bin/bash
              groups: sudo
              lock_passwd: false
              plain_text_passwd: examplepass
          packages:
            - qemu-guest-agent
          runcmd:
            - systemctl enable --now qemu-guest-agent
        qcontroller_network_config: |
          version: 2
          ethernets:
            enp0s2:
              dhcp4: false
              dhcp6: false
              addresses: [192.168.71.83/24]
              routes:
                - to: default
                  via: 192.168.71.3
              nameservers:
                addresses: [1.1.1.1, 8.8.8.8]
    - name: Use VM IP address
      ansible.builtin.debug:
        msg: "VM IP address is {{ qcontroller_result.ipaddresses[0] }}"
      when: qcontroller_result.ipaddresses is defined and qcontroller_result.ipaddresses | length > 0
