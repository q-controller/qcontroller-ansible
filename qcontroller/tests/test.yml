#SPDX-License-Identifier: MIT-0
---
- hosts: localhost
  connection: local
  vars:
    ansible_python_interpreter: "{{ ansible_playbook_python }}"
  remote_user: root
  tasks:
    - name: Download a sample VM image
      get_url:
        url: "https://cloud-images.ubuntu.com/noble/20251113/noble-server-cloudimg-amd64.img"
        checksum: "sha256:https://cloud-images.ubuntu.com/noble/20251113/SHA256SUMS"
        dest: "/tmp/focal-server-cloudimg-amd64.img"
    - name: Test qcontroller_vm module - Start VM
      include_role:
        name: qcontroller
      vars:
        vm_name: "my-vm"
        vm_state: "running"
        vm_image: "cloud-images:ubuntu-noble-20251113"
        vm_file: "/tmp/focal-server-cloudimg-amd64.img"
        vm_userdata: |
          #cloud-config
          ssh_pwauth: true
          users:
            - name: exampleuser
              sudo: ALL=(ALL) NOPASSWD:ALL
              shell: /bin/bash
              groups: sudo
              lock_passwd: false
              ssh-authorized-keys: []
          chpasswd:
            list: |
              exampleuser:examplepass
            expire: false
          packages:
            - qemu-guest-agent
          runcmd:
            - systemctl enable --now qemu-guest-agent
    - name: Use VM IP address
      debug:
        msg: "VM IP address is {{ vm_result.ipaddresses[0] }}"
      when: vm_result.ipaddresses is defined and vm_result.ipaddresses | length > 0
